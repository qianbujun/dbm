<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .action-buttons {
            min-width: 120px;
        }
        .form-container {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="mb-4">Database Manager</h1>
        
        <div class="form-container">
            <h2 id="form-title">Add New Record</h2>
            <form id="data-form">
                <input type="hidden" id="object-id">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="name" required>
                    </div>
                    <div class="col-md-6">
                        <label for="type" class="form-label">Type</label>
                        <select class="form-select" id="type" required>
                            <option value="text/plain">Text</option>
                            <option value="image/jpeg">Image (JPEG)</option>
                            <option value="image/png">Image (PNG)</option>
                            <option value="application/json">JSON</option>
                            <option value="application/pdf">PDF</option>
                            <option value="application/vnd.ms-excel">Excel</option>
                        </select>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="tags" class="form-label">Tags (comma separated)</label>
                        <input type="text" class="form-control" id="tags">
                    </div>
                    <div class="col-md-6">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" required>
                            <option value="new">New</option>
                            <option value="processing">Processing</option>
                            <option value="classified">Classified</option>
                            <option value="archived">Archived</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="content" class="form-label">Content Summary</label>
                    <textarea class="form-control" id="content" rows="3"></textarea>
                </div>
                
                <div class="mb-3">
                    <label for="file" class="form-label">File</label>
                    <input class="form-control" type="file" id="file">
                </div>
                
                <div class="mb-3">
                    <label for="quality_score" class="form-label">Quality Score (0-1)</label>
                    <input type="number" class="form-control" id="quality_score" min="0" max="1" step="0.01">
                </div>
                
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary" id="cancel-btn">Cancel</button>
                </div>
            </form>
        </div>
        
        <h2 class="mb-3">Records</h2>
        
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Created At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="data-table-body">
                    <!-- Records will be loaded here -->
                </tbody>
            </table>
        </div>
        
        <div class="d-flex justify-content-center mt-4">
            <nav>
                <ul class="pagination" id="pagination">
                    <!-- Pagination will be generated here -->
                </ul>
            </nav>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Base API URL
        const API_BASE_URL = '/api/data';
        
        // DOM Elements
        const dataForm = document.getElementById('data-form');
        const formTitle = document.getElementById('form-title');
        const objectIdInput = document.getElementById('object-id');
        const cancelBtn = document.getElementById('cancel-btn');
        const dataTableBody = document.getElementById('data-table-body');
        const paginationElement = document.getElementById('pagination');
        
        // State variables
        let currentOffset = 0;
        const pageSize = 15;
        let totalRecords = 0;
        let currentEditId = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Get offset from URL if available
            const urlParams = new URLSearchParams(window.location.search);
            const offset = parseInt(urlParams.get('offset'));
            if (!isNaN(offset) && offset > 0) {
                currentOffset = offset;
            }
            loadData();
            
            // Form submission handler
            dataForm.addEventListener('submit', handleFormSubmit);
            
            // Cancel button handler
            cancelBtn.addEventListener('click', resetForm);
        });
        
        // Load data from API
        async function loadData() {
            try {
                // Construct proper query parameters
                const params = new URLSearchParams({
                    limit: pageSize,
                    offset: currentOffset
                });
                
                const url = `${API_BASE_URL}?${params.toString()}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                totalRecords = data.total_records; // Use total_records from API
                renderTable(data.data);
                renderPaginationButtons();
            } catch (error) {
                console.error('Error loading data:', error);
                dataTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error loading data: ${error.message}</td></tr>`;
            }
        }
        
        // Render table data
        function renderTable(records) {
            dataTableBody.innerHTML = '';
            
            if (!records || records.length === 0) {
                dataTableBody.innerHTML = '<tr><td colspan="6" class="text-center">No records found</td></tr>';
                return;
            }
            
            records.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.id.substring(0, 8)}...</td>
                    <td>${record.name}</td>
                    <td>${record.type}</td>
                    <td><span class="badge ${getStatusBadgeClass(record.status)}">${record.status}</span></td>
                    <td>${new Date(record.created_at).toLocaleString()}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-info view-btn" data-id="${record.id}">View</button>
                        <button class="btn btn-sm btn-warning edit-btn" data-id="${record.id}">Edit</button>
                        <button class="btn btn-sm btn-danger delete-btn" data-id="${record.id}">Delete</button>
                    </td>
                `;
                dataTableBody.appendChild(row);
            });
            
            // Add event listeners to action buttons
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', () => viewRecord(btn.dataset.id));
            });
            
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => prepareEditForm(btn.dataset.id));
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => deleteRecord(btn.dataset.id));
            });
        }
        
        // Render pagination buttons
        function renderPaginationButtons() {
            paginationElement.innerHTML = '';
            
            if (totalRecords === 0) return;

            const hasPrevious = currentOffset > 0;
            const hasNext = (currentOffset + pageSize) < totalRecords;
            const currentPage = Math.floor(currentOffset / pageSize) + 1;
            const totalPages = Math.ceil(totalRecords / pageSize);

            // Previous button
            const prevLi = document.createElement('li');
            prevLi.classList.add('page-item');
            if (!hasPrevious) {
                prevLi.classList.add('disabled');
            }
            prevLi.innerHTML = `<a class="page-link" href="#" aria-label="Previous"><span aria-hidden="true">«</span></a>`;
            prevLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (hasPrevious) {
                    currentOffset = Math.max(0, currentOffset - pageSize);
                    updateUrlAndLoadData();
                }
            });
            paginationElement.appendChild(prevLi);

            // Page number indicator
            const pageInfoLi = document.createElement('li');
            pageInfoLi.classList.add('page-item', 'disabled');
            pageInfoLi.innerHTML = `<span class="page-link">Page ${currentPage} of ${totalPages}</span>`;
            paginationElement.appendChild(pageInfoLi);

            // Next button
            const nextLi = document.createElement('li');
            nextLi.classList.add('page-item');
            if (!hasNext) {
                nextLi.classList.add('disabled');
            }
            nextLi.innerHTML = `<a class="page-link" href="#" aria-label="Next"><span aria-hidden="true">»</span></a>`;
            nextLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (hasNext) {
                    currentOffset += pageSize;
                    updateUrlAndLoadData();
                }
            });
            paginationElement.appendChild(nextLi);
        }

        function updateUrlAndLoadData() {
            const newUrl = `${window.location.pathname}?offset=${currentOffset}`;
            window.history.pushState({path: newUrl}, '', newUrl);
            loadData();
        }
        
        // Handle form submission
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('name', document.getElementById('name').value);
            formData.append('type', document.getElementById('type').value);
            formData.append('tags', document.getElementById('tags').value);
            formData.append('status', document.getElementById('status').value);
            formData.append('content', document.getElementById('content').value);
            
            const qualityScore = document.getElementById('quality_score').value;
            if (qualityScore) formData.append('quality_score', qualityScore);
            
            const fileInput = document.getElementById('file');
            if (fileInput.files[0]) {
                formData.append('file', fileInput.files[0]);
            }
            
            try {
                let method = 'POST';
                let url = API_BASE_URL;
                
                if (currentEditId) {
                    method = 'PUT';
                    url = `${API_BASE_URL}/${currentEditId}`;
                }
                
                const response = await fetch(url, {
                    method: method,
                    body: formData
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Operation failed');
                }
                
                alert(currentEditId ? 'Record updated successfully!' : 'Record created successfully!');
                resetForm();
                loadData();
            } catch (error) {
                console.error('Error saving record:', error);
                alert('Error saving record: ' + error.message);
            }
        }
        
        // Prepare edit form
        async function prepareEditForm(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/${id}`);
                const record = await response.json();
                
                if (!response.ok) {
                    throw new Error(record.error || 'Failed to load record');
                }
                
                // Fill form fields
                objectIdInput.value = id;
                document.getElementById('name').value = record.name;
                document.getElementById('type').value = record.type;
                document.getElementById('tags').value = record.tags ? record.tags.join(', ') : '';
                document.getElementById('status').value = record.status;
                document.getElementById('content').value = record.content || '';
                document.getElementById('quality_score').value = record.quality_score || '';
                
                formTitle.textContent = 'Edit Record';
                currentEditId = id;
                window.scrollTo(0, 0); // Scroll to top to see the form
            } catch (error) {
                console.error('Error loading record:', error);
                alert('Error loading record: ' + error.message);
            }
        }
        
        // View record details
        function viewRecord(id) {
            window.open(`/api/data/${id}`, '_blank');
        }
        
        // Delete record
        async function deleteRecord(id) {
            if (!confirm('Are you sure you want to delete this record?')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Deletion failed');
                }
                
                alert('Record deleted successfully!');
                loadData();
            } catch (error) {
                console.error('Error deleting record:', error);
                alert('Error deleting record: ' + error.message);
            }
        }
        
        // Reset form to add new record
        function resetForm() {
            dataForm.reset();
            objectIdInput.value = '';
            formTitle.textContent = 'Add New Record';
            currentEditId = null;
        }
        
        // Get badge class based on status
        function getStatusBadgeClass(status) {
            if (!status) return 'bg-dark'; // Handle empty status
            
            switch (status) {
                case 'new': return 'bg-primary';
                case 'processing': return 'bg-info';
                case 'classified': return 'bg-success';
                case 'archived': return 'bg-secondary';
                default: return 'bg-dark';
            }
        }
    </script>
</body>
</html>